{% extends "layouts/base.html" %}

{% block title %} UI Tables {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

{% endblock stylesheets %}

{% block content %}
<script>
    $(document).ready(function(){
    setInterval(function(){
        $.ajax({
            type: 'GET',
            url : "get_message",
            success: function(response){
                console.log(response);
                $("#display").empty();
                for (var key in response.messages)
                { 
                    var dateT = new Date(response.messages[key].date);
                    str=dateT.toLocaleString();
                    if(response.messages[key].type == "1")
                    {
                        var tmp ="<div class=\"row\" style=\"margin-top: 20px;\"><div class=\"col-sm-1  grid-margin\"><img src=\"/static/assets/images/faces/face15.jpg\" style =\"width:100%;\" alt=\"image\" class=\"rounded-circle profile-pic\"></div><div class=\"col-sm-10\" grid-margin><a><h4>"
                        tmp+= str+":"+response.messages[key].user +"</h4></a><hr style=\"margin-top:0;\"></hr>"
                       
                        for(i in response.messages[key].msg.split('\n'))
                        {
                         tmp+="<p>"+response.messages[key].msg.split('\n')[i]+"</p>"
                        }
                        tmp+="</div></div>"
                        $("#display").append(tmp);

                    }
                    else
                    {
                        var tmp ="<div class=\"row\" style=\"margin-left: 100px;margin-top: 20px;\"><div class=\"col-sm-1  grid-margin\"><img src=\"/static/assets/images/faces/face2.jpg\" style =\"width:100%;\" alt=\"image\" class=\"rounded-circle profile-pic\"></div><div class=\"col-sm-10\" grid-margin><a><h4>"
                        tmp+= str+":"+response.messages[key].user +"</h4></a><hr style=\"margin-top:0;\"></hr><a>"
                        for(i in response.messages[key].msg.split('\n'))
                        {
                         tmp+="<p>"+response.messages[key].msg.split('\n')[i]+"</p>"
                        }
                        tmp+="</div></div>"
                        $("#display").append(tmp);
                    }

                   
                }
            },
            error: function(response){
                //alert('An error occured')
            }
        });
    },1000);
    })
</script>
<div class="content-wrapper">
    <!--Header-->
    <div class="page-header">
        <h1 class="page-title"> Online Support</h1>
    </div>   
    <!-- [ Main Content ] start -->
    <div class="row">
        <!--[D F info] start-->
        <div class="col-sm-12  grid-margin">
            <div class="card">
                <div class="card-header">
                    <h5>
                        If support is offline you can always leave your message and wiil
                        reply as soon as possible once available
                    </h5>
                </div>
                <div class="card-body" style = "height:600px;overflow-y:auto;">
                    <div id="display"  class="clearfix">
                        
                        
                    </div>
                </div>
                <div class ="card-footer">
                    <div class="row">
                        <div class = "col-sm-11">
                            <input type="hidden" name="onlineSupport_message_username" id="onlineSupport_message_username" value="{{user_name}}"/>
                            <textarea rows = "2" cols = "60"  name="onlineSupport_message" id = "onlineSupport_message" style="width:100%;"></textarea>
                  
                        </div>
                        <div class = "col-sm-1">
                            <button class="btn btn-primary"  onclick="send_message_click()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function send_message_click() {
        $.ajax({
            type: 'POST',
            url : "send_message",
            data:{
                user:$('#onlineSupport_message_username').val(),
                message:$('#onlineSupport_message').val(),
                csrfmiddlewaretoken:getCookie("csrftoken"),
            },
            success: function(response){
                console.log(response.messages);
            },
            error: function(response){
                alert('An error occured')
            } 
            }
        )    
    }
         
</script> 
{% endblock content %}
